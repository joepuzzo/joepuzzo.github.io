<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <title>Synchronization/Mutual exclusion</title>
    <link type="text/css" rel="stylesheet" href="assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="assets/css/hljs-github.min.css"/>
    <style>
      body {
        min-width: 200px;
        max-width: 790px;
        margin: 0 auto;
        padding: 30px;
      }
    </style>
  </head>
  <body>
    <article class="markdown-body"><h2 id="synchronization-mutual-exclusion"><a class="header-link" href="#synchronization-mutual-exclusion"></a>Synchronization/Mutual exclusion</h2>
<ul class="list">
<li>Synchronization - several threads access</li>
<li>Mutual Exclusion - update shared variables at the same time =&gt; ensure that the code executes correctly</li>
</ul>
<h2 id="example-1"><a class="header-link" href="#example-1"></a>Example 1</h2>
<pre class="hljs"><code>shared double balance<span class="hljs-comment">;</span>
<span class="hljs-label">T1:</span> credit - balance = balance - debit      T2: debit  - balance = balance + credit

balance = <span class="hljs-number">100</span>       credit = <span class="hljs-number">50</span>     debit = <span class="hljs-number">10</span>      Correct answer = <span class="hljs-number">140</span>

Assembly code: T1               Assembly code: T2    
<span class="hljs-number">1.</span> Load <span class="hljs-built_in">R1</span>, balance             Load <span class="hljs-built_in">R1</span>, balance
<span class="hljs-number">2.</span> Load <span class="hljs-built_in">R2</span>, credit              Load <span class="hljs-built_in">R2</span>, credit
<span class="hljs-number">3.</span> <span class="hljs-keyword">Add</span> <span class="hljs-built_in">R1</span>,R                     <span class="hljs-keyword">Sub</span> <span class="hljs-built_in">R1</span>,<span class="hljs-built_in">R2</span>
<span class="hljs-number">4.</span> Store <span class="hljs-built_in">R1</span>, balance            Store <span class="hljs-built_in">R1</span>, balance

<span class="hljs-label">Time:</span> 
---T1:<span class="hljs-number">1</span>----T1:<span class="hljs-number">2</span>---|--T2:<span class="hljs-number">1</span>---T2:<span class="hljs-number">2</span>--T2:<span class="hljs-number">3</span>--T2:<span class="hljs-number">4</span>--|---T1:<span class="hljs-number">3</span>---T1:<span class="hljs-number">4</span>---------------------&gt;
  <span class="hljs-built_in">R1</span>:<span class="hljs-number">100</span>   <span class="hljs-built_in">R2</span>:<span class="hljs-number">50</span>    <span class="hljs-built_in">R1</span>:<span class="hljs-number">100</span>  <span class="hljs-built_in">R2</span>:<span class="hljs-number">10</span>                <span class="hljs-built_in">R1</span>:<span class="hljs-number">100</span>   <span class="hljs-built_in">R2</span>:<span class="hljs-number">50</span>            
                                  balance = <span class="hljs-number">90</span>   balance = <span class="hljs-number">100</span> again.. oops</code></pre><h2 id="race-condition"><a class="header-link" href="#race-condition"></a>Race Condition</h2>
<ul class="list">
<li>outcome depends on the order in which execution takes place </li>
<li>Objective ensure race condition does not occur</li>
<li>Solution1: the shared variable must only be accessed in a <code>critical section</code> of code</li>
<li><code>No fucking shit</code></li>
<li>Mutex </li>
</ul>
<h2 id="solution-to-cs-implementation"><a class="header-link" href="#solution-to-cs-implementation"></a>Solution to <CS> implementation</h2>
<ul class="list">
<li>Software without HW or OS support</li>
<li>HW</li>
<li>OS <ul class="list">
<li>mutex ( binary semaphore )</li>
<li>semaphores</li>
<li>monitors</li>
</ul>
</li>
</ul>
<h2 id="properties-you-want-for-your-cs-"><a class="header-link" href="#properties-you-want-for-your-cs-"></a>Properties you want for your <CS></h2>
<ol class="list">
<li>Mutual exclusion (me) : one thread accessing global at a time</li>
<li>No starvation  - when a thread wants to enter <CS>, it should eventually get in. <code>Everyone wants to come to the party</code></li>
<li>No deadlocks   - ensure that the <CS> is not idle when there are threads wanting in </li>
<li><CS> termination: ensure that threads remain in <CS> a finite time</li>
<li>legal death: a thread dying outside the <CS> should not block other threads from getting into the <CS></li>
<li>No speed differential: if 1 thread wants to enter <CS> multiple times it should be allowed</li>
</ol>
<h2 id="solution-sw-without-os-support"><a class="header-link" href="#solution-sw-without-os-support"></a>Solution SW without OS support </h2>
<pre class="hljs"><code><span class="hljs-comment">//T1</span>
<span class="hljs-keyword">for</span>(;;) { 
    ...
    <span class="hljs-keyword">while</span>( term == <span class="hljs-number">2</span> ); <span class="hljs-comment">//Enter &lt;CS&gt;</span>
    balance=balance +credit;
    term = <span class="hljs-number">2</span>; <span class="hljs-comment">//Exit &lt;CS&gt;</span>
    ...
}</code></pre><pre class="hljs"><code><span class="hljs-comment">//T2</span>
<span class="hljs-keyword">for</span>(;;) { 
    ...
    <span class="hljs-keyword">while</span>( term == <span class="hljs-number">1</span> ); <span class="hljs-comment">//Enter &lt;CS&gt;</span>
    balance=balance +credit;
    term = <span class="hljs-number">1</span>; <span class="hljs-comment">//Exit &lt;CS&gt;</span>
    ...
}</code></pre><h2 id="solution-sw-with-permissions"><a class="header-link" href="#solution-sw-with-permissions"></a>Solution SW with permissions</h2>
<pre class="hljs"><code><span class="hljs-comment">//T1</span>
<span class="hljs-keyword">for</span>(;;) { 
    ...
    <span class="hljs-keyword">while</span>( permission2 == <span class="hljs-keyword">false</span> ); <span class="hljs-comment">//Enter &lt;CS&gt;</span>
    permission1 = <span class="hljs-keyword">false</span>
    balance=balance +credit;
    permission1 = <span class="hljs-keyword">true</span>; <span class="hljs-comment">//Exit &lt;CS&gt;</span>
    ...
}</code></pre><pre class="hljs"><code><span class="hljs-comment">//T1</span>
<span class="hljs-keyword">for</span>(;;) { 
    ...
    <span class="hljs-keyword">while</span>( permission1 == <span class="hljs-keyword">false</span> ); <span class="hljs-comment">//Enter &lt;CS&gt;</span>
    permission2 = <span class="hljs-keyword">false</span>
    balance=balance +credit;
    permission2 = <span class="hljs-keyword">true</span>; <span class="hljs-comment">//Exit &lt;CS&gt;</span>
    ...
}</code></pre><h2 id="solution-pearsons-algorithm"><a class="header-link" href="#solution-pearsons-algorithm"></a> Solution Pearsons Algorithm</h2>
<pre class="hljs"><code><span class="hljs-comment">//T1</span>
<span class="hljs-keyword">for</span>(;;) { 
    ...
    permission1 = <span class="hljs-keyword">false</span>
    turn = <span class="hljs-number">2</span>
    <span class="hljs-keyword">while</span>( permission2 == <span class="hljs-keyword">false</span> &amp;&amp; turn = <span class="hljs-number">2</span> ); <span class="hljs-comment">//Enter &lt;CS&gt;</span>
    balance=balance +credit;
    permission1 = <span class="hljs-keyword">true</span>; <span class="hljs-comment">//Exit &lt;CS&gt;</span>
    ...
}</code></pre><pre class="hljs"><code><span class="hljs-comment">//T1</span>
<span class="hljs-keyword">for</span>(;;) { 
    ...
    permission2 = <span class="hljs-keyword">false</span>
    turn = <span class="hljs-number">1</span>
    <span class="hljs-keyword">while</span>( permission1 == <span class="hljs-keyword">false</span> &amp;&amp; turn = <span class="hljs-number">1</span> ); <span class="hljs-comment">//Enter &lt;CS&gt;</span>
    balance=balance +credit;
    permission2 = <span class="hljs-keyword">true</span>; <span class="hljs-comment">//Exit &lt;CS&gt;</span>
    ...
}</code></pre><h2 id="solution-hw-with-swap"><a class="header-link" href="#solution-hw-with-swap"></a>Solution HW with swap</h2>
<pre class="hljs"><code><span class="hljs-comment">// Shared variable</span>
boolean lock = <span class="hljs-keyword">false</span>; <span class="hljs-comment">//initial value</span>
<span class="hljs-function">boolean key
<span class="hljs-title">for</span><span class="hljs-params">(;;)</span> </span>{ 
    ...
    key = <span class="hljs-keyword">true</span>; 
    <span class="hljs-keyword">while</span>(key == <span class="hljs-keyword">true</span>) swap(&amp;key,&amp;lock);
    balance = ...
    lock = <span class="hljs-keyword">false</span>;
    ...
    <span class="hljs-comment">//non &lt;cs&gt; code</span>
}</code></pre><h1 id="analysis"><a class="header-link" href="#analysis"></a>Analysis</h1>
<ol class="list">
<li>ME holds, T1 will go past while loop, lock = true when T1 is executing in the <CS></li>
<li>no deadlock</li>
<li>starvation possible </li>
<li>speed differential T1 can enter multiple time</li>
<li>Killing a thread </li>
</ol>
<h1 id="advantages-of-hw-solution"><a class="header-link" href="#advantages-of-hw-solution"></a>Advantages of HW solution</h1>
<ol class="list">
<li>solution for two threads also works for n &gt; 2 threads</li>
</ol>
<h1 id="disadvantage-of-hw-solution"><a class="header-link" href="#disadvantage-of-hw-solution"></a>Disadvantage of HW solution</h1>
<ol class="list">
<li>spin locking for entry into <CS></li>
</ol>
<h1 id="os-solution"><a class="header-link" href="#os-solution"></a>OS Solution</h1>
<ul class="list">
<li>Semaphores</li>
<li>monitors</li>
</ul>
<h2 id="semaphores"><a class="header-link" href="#semaphores"></a>Semaphores</h2>
<ul class="list">
<li>A semaphore is a special variable type <pre class="hljs"><code>  <span class="hljs-keyword">int</span> i; 
  semaphore s;</code></pre></li>
<li>a semaphore variable can be initialized to any integer &gt;= 0</li>
<li>only 2 operations permitted on a semaphore <pre class="hljs"><code>  wait( s );      <span class="hljs-comment">//p(s) </span>
  signal( s );    <span class="hljs-comment">//v(s)</span></code></pre></li>
<li>every semaphore variable has its own queue</li>
<li>p() &amp; v() are atomic functions ( written using HW atomic functions )</li>
<li>value of semaphore represents how many threads are waiting <ul class="list">
<li>so if s = -3 there are 3 threads waiting in the queue</li>
</ul>
</li>
<li>default semaphore que is FIFO </li>
</ul>
<h3 id="the-design-of-p-s-"><a class="header-link" href="#the-design-of-p-s-"></a>The design of p(s)</h3>
<pre class="hljs"><code><span class="hljs-comment">// Wait</span>
<span class="hljs-comment">// if s &lt;= 0 block the calling thread</span>
p(s) { 
    <span class="hljs-comment">//decrement the semaphore </span>
    s = s - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> ( s &gt;= <span class="hljs-number">0</span> ) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// do not block </span>
    <span class="hljs-keyword">else</span> { 
        <span class="hljs-comment">//calling thread is taken out of running state to blocked state</span>
    } 
}</code></pre><h3 id="the-design-of-v-s-"><a class="header-link" href="#the-design-of-v-s-"></a>The design of v(s)</h3>
<pre class="hljs"><code><span class="hljs-comment">// </span>
v(s) { 
    <span class="hljs-comment">//increment the semaphore</span>
    s = s + <span class="hljs-number">1</span>
    <span class="hljs-comment">//If the semaphore queue is empty</span>
    <span class="hljs-keyword">if</span> ( s &gt; <span class="hljs-number">0</span>  ) <span class="hljs-keyword">continue</span>; 
    <span class="hljs-keyword">else</span> { 
        <span class="hljs-comment">//wake the thread at the head of the queue </span>
        <span class="hljs-comment">//Unblocked thread joins the ready queue</span>
    } 
}</code></pre><h3 id="example-"><a class="header-link" href="#example-"></a>Example:</h3>
<pre class="hljs"><code><span class="hljs-comment">//Shared variables</span>
<span class="hljs-keyword">double</span> balance; 
semaphore s1 = s2 = s3 = <span class="hljs-number">1</span>; 
T1:                             T2:                   T3: 
    ...                            ...                  ...  
    p(s1)                          p(s2)                 p(s3)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"x"</span>)                    p(s2)                 p(s2)
    v(s3)                          <span class="hljs-built_in">printf</span>(<span class="hljs-string">"y"</span>)           <span class="hljs-built_in">printf</span>(<span class="hljs-string">"z"</span>)
    v(s2)                          v(s2)                 v(s1)
    ...                            ...                  ...</code></pre><pre class="hljs"><code>outpu<span class="hljs-variable">t:</span> 
<span class="hljs-keyword">y</span> can never <span class="hljs-keyword">print</span> before <span class="hljs-keyword">x</span> 
Example<span class="hljs-variable">s:</span> xyz, <span class="hljs-keyword">x</span></code></pre><h1 id="classical-problems"><a class="header-link" href="#classical-problems"></a>Classical Problems</h1>
<h2 id="bounded-buffer-problem-producer-consumer"><a class="header-link" href="#bounded-buffer-problem-producer-consumer"></a>Bounded buffer problem / producer consumer</h2>
<ul class="list">
<li>Synchronization<ol class="list">
<li>prevent the producer and consumer from accessing the same buffer</li>
<li>block the consumer if all buffers are empty </li>
<li>block the producer if all buffers are full </li>
</ol>
</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">int</span> c; <span class="hljs-comment">//index of next buffer to be consumed</span>
<span class="hljs-keyword">int</span> p; <span class="hljs-comment">//index of next buffer to be filled</span>
<span class="hljs-keyword">char</span> buffer[<span class="hljs-number">0.</span>.N-<span class="hljs-number">1</span>];
semaphore f; <span class="hljs-comment">// full buffers </span>
semaphore e; <span class="hljs-comment">// empty buffers </span>
c = p = <span class="hljs-number">0</span>; 
f = <span class="hljs-number">0</span>; 
e = N

<span class="hljs-comment">//Producer</span>
<span class="hljs-keyword">for</span>(;;;) { 
    p(e) <span class="hljs-comment">//wait for empty buffer </span>
    fill buffer[p]; 
    p = p + <span class="hljs-number">1</span> % N; 
    v(f)
} 

<span class="hljs-comment">//Consumer</span>
<span class="hljs-keyword">for</span>(;;;) { 
    p(f) <span class="hljs-comment">//wait for empty full buffer </span>
    empty buffer[p]; 
    c = c + <span class="hljs-number">1</span> % N; 
    v(e)
}</code></pre><h2 id="reader-writer-problem"><a class="header-link" href="#reader-writer-problem"></a>Reader - Writer problem</h2>
<ul class="list">
<li>Multiple reader and writer threads</li>
<li>shared &quot;variable&quot;: file </li>
<li>readers can read file concurrently </li>
<li>writer thread writes in exclusive mode </li>
<li>Solutions: <ul class="list">
<li>Reader priority </li>
<li>Writer priority </li>
</ul>
</li>
</ul>
<h3 id="the-implementation-of-p-"><a class="header-link" href="#the-implementation-of-p-"></a>The Implementation of P()</h3>
<pre class="hljs"><code>boolean lock = <span class="hljs-keyword">false</span>;
p(s) { 
    boolean key; 
    key = <span class="hljs-keyword">true</span>; 
    <span class="hljs-comment">// This while stops two calls to p() from getting into p's critical section at the same time</span>
    <span class="hljs-keyword">while</span>( key == <span class="hljs-keyword">true</span> ) swap(lock,key); 
    &lt;Critical Section&gt;
    s = s - <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span>( s &lt; <span class="hljs-number">0</span> ) { 
        lock = <span class="hljs-keyword">false</span> 
        block 
    } <span class="hljs-keyword">else</span> { 
        lock = <span class="hljs-keyword">false</span> 
    } 
}</code></pre><h1 id="monitors"><a class="header-link" href="#monitors"></a>Monitors</h1>
<ul class="list">
<li>Monitors and semaphores are equivalent</li>
<li><p>Abstract data type ( object oriented version of semaphores )</p>
<pre class="hljs"><code>  |   Shared Data | Condition variables a,b | 
  |-----------------------------------------| 
  |  a1sQ [....        b1sq [ ........      |
  |-----------------------------------------|
  | <span class="hljs-function"><span class="hljs-keyword">Procedure</span>      <span class="hljs-title">Function</span>      <span class="hljs-title">Procedure</span>  |
  |-----------------------------------------| 
  |           <span class="hljs-title">Initialization</span> <span class="hljs-title">code</span>           |</span></code></pre><h2 id="monitor"><a class="header-link" href="#monitor"></a>Monitor</h2>
</li>
<li>Mutually exclusive usage</li>
<li>Monitor entry queue</li>
<li>monitor variables cannot be accessed outside </li>
<li>1 Thread active inside the monitor at a time</li>
<li><ul class="list">
<li>Requests an unavailable resource</li>
<li>blocks on condition variable queue ( until it gets signaled )</li>
</ul>
</li>
</ul>
<pre class="hljs"><code>condition c; 
c.wait()
c.signal()</code></pre><h2 id="example"><a class="header-link" href="#example"></a>Example</h2>
<pre class="hljs"><code>monitor bank
{
<span class="hljs-keyword">float</span> balance; 
    increment(x) { 
        balance += x
    } 
    decrement(x) { 
        balance -= x 
    } 
    bank s; 
}</code></pre><h2 id="condition-variables"><a class="header-link" href="#condition-variables"></a>Condition Variables</h2>
<h3 id="wait"><a class="header-link" href="#wait"></a>Wait</h3>
<ul class="list">
<li><code>c.wait()</code> : suspend execution of the calling thread. Thread waits in c&#39;s condition queue. Monitor is now free and avalible</li>
<li>P(s) vs c.wait()<ul class="list">
<li><code>P(s)</code> only blocks if <code>s &lt;= 0</code> </li>
<li><code>c.wait()</code> always blocks</li>
</ul>
</li>
</ul>
    </article>
  </body>
</html>
